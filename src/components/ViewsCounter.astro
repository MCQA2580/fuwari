---
import { Icon } from "astro-icon/components";

type Props = {
	pathname: string;
	suffix?: string;
	id?: string;
};

const { pathname, suffix = "æ¬¡" } = Astro.props;
const id =
	Astro.props.id ?? `page-views-${pathname.replace(/[^a-zA-Z0-9]+/g, "-")}`;
---

<div class="flex items-center">
	<div class="meta-icon">
		<Icon name="material-symbols:visibility-outline-rounded" class="text-xl" />
	</div>
	<span class="text-50 text-sm font-medium" id={id}>0 {suffix}</span>
</div>

<script define:vars={{ pathname, id, suffix }}>
	function animateValue(obj, start, end, duration, suffixText) {
		let startTimestamp = null;
		const step = (timestamp) => {
			if (!startTimestamp) startTimestamp = timestamp;
			const progress = Math.min((timestamp - startTimestamp) / duration, 1);
			obj.innerHTML = `${Math.floor(progress * (end - start) + start)} ${suffixText}`;
			if (progress < 1) window.requestAnimationFrame(step);
			else obj.innerHTML = `${end} ${suffixText}`;
		};
		window.requestAnimationFrame(step);
	}

	async function loadViews() {
		const el = document.getElementById(id);
		if (!el) return;
		try {
			const res = await fetch(
				`https://t.2x.nz/share?pathname=${encodeURIComponent(pathname)}`,
			);
			if (!res.ok) return;
			const data = await res.json();
			const views = data?.views || 0;
			const current = Number.parseInt(el.textContent || "0", 10) || 0;
			if (current === 0) animateValue(el, 0, views, 1000, suffix);
			else el.innerHTML = `${views} ${suffix}`;
		} catch {}
	}

	if (document.readyState === "loading")
		document.addEventListener("DOMContentLoaded", loadViews);
	else loadViews();
	document.addEventListener("astro:after-swap", loadViews);
	document.addEventListener("content:replace", loadViews);
	document.addEventListener("swup:contentReplaced", loadViews);
</script>
