---
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { Icon } from "astro-icon/components";

const breadcrumbSchema = {
	"@context": "https://schema.org",
	"@type": "BreadcrumbList",
	itemListElement: [
		{
			"@type": "ListItem",
			position: 1,
			name: "首页",
			item: Astro.site,
		},
		{
			"@type": "ListItem",
			position: 2,
			name: "文章变更",
			item: new URL("/changes", Astro.site).toString(),
		},
	],
};
---

<MainGridLayout title="文章变更">
    <script is:inline slot="head" type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)}></script>
    
    <div class="card-base p-6 md:p-8">
        <div class="flex items-center gap-2 mb-6">
            <div class="h-8 w-8 rounded-lg bg-[var(--primary)] flex items-center justify-center text-white dark:text-black/70">
                <Icon name="material-symbols:history-edu-rounded" class="text-[1.5rem]"></Icon>
            </div>
            <h1 class="text-2xl font-bold text-black dark:text-white">文章变更</h1>
        </div>
        
        <div id="changes-info" class="text-sm text-black/50 dark:text-white/50 mb-4"></div>
        
        <div id="changes-list" class="space-y-6">
            <div class="text-center text-black/40 dark:text-white/40 py-8">
                <Icon name="material-symbols:hourglass-top" class="text-4xl mb-2 block mx-auto"></Icon>
                <p>加载中...</p>
            </div>
        </div>
    </div>
</MainGridLayout>

<script>
const INIT_TIME_KEY = "fuwari-notification-init-time";
const NOTIFICATION_STATE_KEY = "fuwari-notification-state";

function getRelativeUrl(href) {
	try {
		const url = new URL(href, window.location.origin);
		return `${url.pathname}${url.search}${url.hash}`;
	} catch {
		return href;
	}
}

function linkToDiff(href) {
	try {
		const url = new URL(href, window.location.origin);
		url.searchParams.set("diff", "1");
		url.hash = "post-diff";
		return `${url.pathname}${url.search}${url.hash}`;
	} catch {
		const base = href.split("#")[0];
		const hash = "#post-diff";
		if (base.includes("?")) return `${base}&diff=1${hash}`;
		return `${base}?diff=1${hash}`;
	}
}

function escapeHtml(text) {
	return String(text ?? "")
		.replace(/&/g, "&amp;")
		.replace(/</g, "&lt;")
		.replace(/>/g, "&gt;")
		.replace(/"/g, "&quot;")
		.replace(/'/g, "&#039;");
}

async function init() {
    const listEl = document.getElementById('changes-list');
    const infoEl = document.getElementById('changes-info');
    
    if (!listEl) return;
    
    try {
		const initTimestamp = localStorage.getItem(INIT_TIME_KEY);
		const initTimeStr = initTimestamp ? new Date(parseInt(initTimestamp)).toLocaleString() : "未知";
		const nowStr = new Date().toLocaleString();

		const persistedStateStr = localStorage.getItem(NOTIFICATION_STATE_KEY);
		let changes = [];
		let stateTimeStr = nowStr;

		if (persistedStateStr) {
			try {
				const state = JSON.parse(persistedStateStr);
				changes = Array.isArray(state?.items) ? state.items : [];
				stateTimeStr = state?.timestamp ? new Date(state.timestamp).toLocaleString() : nowStr;
			} catch (e) {
				console.error("Failed to parse persisted state:", e);
			}
		}

		if (infoEl) {
			infoEl.innerHTML = `
				<div class="flex flex-wrap gap-4 text-xs">
					<span class="bg-black/5 dark:bg-white/5 px-2 py-1 rounded">
						<span class="opacity-60">开始追踪:</span> ${initTimeStr}
					</span>
					<span class="bg-black/5 dark:bg-white/5 px-2 py-1 rounded">
						<span class="opacity-60">最后变更:</span> ${stateTimeStr}
					</span>
					<span class="bg-black/5 dark:bg-white/5 px-2 py-1 rounded">
						<span class="opacity-60">变更数量:</span> ${changes.length} 条
					</span>
				</div>
			`;
		}

		if (changes.length === 0) {
			listEl.innerHTML = `
				<div class="text-center text-black/40 dark:text-white/40 py-8">
					<p class="font-medium">没有发现文章变更</p>
					<p class="text-xs mt-2 opacity-60">系统会在后续访问中追踪文章变更</p>
				</div>
			`;
			return;
		}

		const sorted = [...changes].sort((a, b) => Number(b?.pubDate ?? 0) - Number(a?.pubDate ?? 0));
		const cards = sorted
			.map((post) => {
				const isUpdated = !!post?.isUpdated;
				const hasDiff = isUpdated && !!post?.diff;
				const postLink = getRelativeUrl(String(post?.link ?? "#"));
				const jumpLink = hasDiff ? linkToDiff(postLink) : postLink;

				const badge = isUpdated
					? '<span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 px-2 py-1 rounded shrink-0">更新</span>'
					: '<span class="text-xs bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-300 px-2 py-1 rounded shrink-0">新文章</span>';

				const hint = hasDiff
					? '<span class="text-xs text-[var(--primary)] shrink-0">进入文章查看 DIFF</span>'
					: '<span class="text-xs text-black/40 dark:text-white/40 shrink-0">进入文章查看</span>';

				return `
					<div class="border border-black/10 dark:border-white/10 rounded-xl overflow-hidden">
						<div class="bg-black/[0.02] dark:bg-white/[0.02] p-4">
							<div class="flex items-center justify-between gap-4">
								<div class="flex items-center gap-3 min-w-0">
									${badge}
									<a href="${jumpLink}" class="font-bold text-black dark:text-white hover:text-[var(--primary)] transition-colors truncate">
										${escapeHtml(post?.title ?? "")}
									</a>
								</div>
								${hint}
							</div>
						</div>
					</div>
				`;
			})
			.join("");

		listEl.innerHTML = `<div class="space-y-4">${cards}</div>`;
        
    } catch (e) {
        console.error('Failed to load changes:', e);
        listEl.innerHTML = `
            <div class="text-center text-red-500 py-8">
                <p>加载失败</p>
                <p class="text-xs mt-2 opacity-60">${e}</p>
            </div>
        `;
    }
}

init();
</script>
